version: "3.9"

services:
  webapp:
    build: ./user-interface
    container_name: webapp
    ports:
      - "5003:5003"
    volumes:
      - user:/volumes/user
      - data:/volumes/data
    depends_on:
      - model-inference  # Ensure inference is available before UI starts
    networks:
      - app_network

  data-preprocessing:
    build: ./data-preprocessing
    container_name: data-preprocessing
    expose:
      - "5000"
    volumes:
      - raw_data:/volumes/raw_data
      - user:/volumes/user
      - data:/volumes/data
    networks:
      - app_network
    command: ["python", "./preprocess.py"]

  model-training:
    build: ./model-training
    container_name: model-training
    expose:
      - "5001"
    volumes:
      - ./volumes/data:/volumes/data
      - ./volumes/models:/volumes/models
    environment:
      - TRAINING_FILE_PATH=/volumes/data/clean_wine_quality.csv
      - SAVED_MODEL_DIR=/volumes/models/saved_model.pkl
    networks:
      - app_network
    depends_on:
      - data-preprocessing  # Ensure preprocessing completes before training
    command: ["python", "./train_model.py"]

  model-inference:
    build: ./model-inference
    container_name: model-inference
    expose:
      - "5002"
    volumes:
      - data:/volumes/data
      - models:/volumes/models
      - user:/volumes/user
    networks:
      - app_network
    depends_on:
      - model-training  # Ensure trained model exists before inference
    command: ["python", "./inference.py"]

volumes:
  user:  # ðŸ”¹ User input for predictions
  data:  # ðŸ”¹ Processed data storage
  models:  # ðŸ”¹ Trained models
  raw_data: /raw_data

networks:
  app_network:
    driver: bridge
